<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>2025.07.10 | Quinn&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="过程艰难，但AI真好用，整理一下遇到的问题，收获不小
">
    <meta name="generator" content="Hugo 0.147.3">
    
    
    
      <meta name="robots" content="noindex, nofollow">
    
    

    
<link rel="stylesheet" href="/blog/ananke/css/main.min.css" >




    


    
      

    

    

    
      <link rel="canonical" href="http://localhost:1313/blog/diary/2025.07/2025.07.10/">
    

    <meta property="og:url" content="http://localhost:1313/blog/diary/2025.07/2025.07.10/">
  <meta property="og:site_name" content="Quinn&#39;s Blog">
  <meta property="og:title" content="2025.07.10">
  <meta property="og:description" content="过程艰难，但AI真好用，整理一下遇到的问题，收获不小">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="diary">
    <meta property="article:published_time" content="2025-07-10T10:16:33+08:00">
    <meta property="article:modified_time" content="2025-07-10T10:16:33+08:00">

  <meta itemprop="name" content="2025.07.10">
  <meta itemprop="description" content="过程艰难，但AI真好用，整理一下遇到的问题，收获不小">
  <meta itemprop="datePublished" content="2025-07-10T10:16:33+08:00">
  <meta itemprop="dateModified" content="2025-07-10T10:16:33+08:00">
  <meta itemprop="wordCount" content="351">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="2025.07.10">
  <meta name="twitter:description" content="过程艰难，但AI真好用，整理一下遇到的问题，收获不小">

	
  </head><body class="ma0 garamond bg-near-white development">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/blog/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Quinn&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/blog/" title="Home page">
              Home
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/blog/tech" title="Tech page">
              Tech
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/blog/read" title="Read page">
              Read
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/blog/stock" title="Stock page">
              Stock
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/blog/life_coach" title="Life Coach page">
              Life Coach
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/blog/diary" title="Diary page">
              Diary
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/blog/product" title="Product page">
              Product
            </a>
          </li>
          
        </ul>
      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Diary
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">2025.07.10</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2025-07-10T10:16:33+08:00">July 10, 2025</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>过程艰难，但AI真好用，整理一下遇到的问题，收获不小
<img src="img_1.png" alt="img_1.png"></p>
<p>工作：</p>
<ul>
<li>部署browser use demo</li>
</ul>
<h1 id="rootvm-88-228-centos-browser-use-docker-logs-51d04a33dbb2">[root@VM-88-228-centos browser-use]# docker logs 51d04a33dbb2</h1>
<p>Error: Can&rsquo;t drop privilege as nonroot user  [supervisord]
好的，这是一个非常经典且优质的问题，它清楚地展示了在使用 Docker、非 root 用户和进程管理器（如 Supervisor）时一个常见的困惑点。</p>
<p>下面我将为你详细剖析问题原因，并提供解决方案。</p>
<h3 id="问题分析">问题分析</h3>
<ol>
<li>
<p><strong>错误信息解读：</strong> <code>Error: Can't drop privilege as nonroot user [supervisord]</code></p>
<ul>
<li><strong>它在说什么：</strong> <code>Supervisor</code> 告诉你，它尝试切换到一个不同的用户来运行某个程序，但失败了。这个操作（“降权”或“切换用户”）需要 <code>root</code> 权限。错误信息明确指出，<code>Supervisor</code> 程序本身正在以一个 <strong>非 root 用户（nonroot user）</strong> 的身份运行。</li>
</ul>
</li>
<li>
<p><strong>Supervisor 为什么以非 root 身份运行?</strong></p>
<ul>
<li>我们来看你的 <code>Dockerfile</code>，最后几行是关键：
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># 7. 以非 root 用户身份安装项目级的 Playwright</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> ${APP_USER}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> ${APP_HOME}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> npm install playwright@<span style="color:#e6db74">${</span>PW_VERSION<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> rm -rf /tmp/* ~/.npm<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 8. 暴露端口，并设置默认命令</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> ${NOVNC_PORT}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> ${PW_PORT}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/usr/bin/supervisord&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;/etc/supervisor/conf.d/supervisord.conf&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div></li>
<li><code>USER ${APP_USER}</code> 这条指令（这里的 <code>${APP_USER}</code> 是 <code>pwuser</code>）会设置后续所有指令的默认执行用户。</li>
<li>因此，你的 <code>CMD</code> 命令，也就是启动 <code>supervisord</code> 的命令，最终是以 <code>pwuser</code> 这个普通用户的身份执行的。</li>
</ul>
</li>
<li>
<p><strong>Supervisor 为什么需要“降权”？</strong></p>
<ul>
<li>我们再看你的 <code>supervisord.conf</code> 配置文件。你管理的每一个程序都有这样一行：
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#a6e22e">user</span><span style="color:#f92672">=</span><span style="color:#e6db74">pwuser</span>
</span></span></code></pre></div></li>
<li>当 <code>Supervisor</code> 看到 <code>user=</code> 这个指令时，它的工作职责就是去把指定的程序（如 vnc, fluxbox 等）以 <code>pwuser</code> 这个用户的身份启动。要完成这个任务，它需要调用一个系统函数来改变进程的用户 ID。</li>
<li><strong>只有 <code>root</code> 用户才有权限将一个进程的用户 ID 切换成别人。</strong></li>
</ul>
</li>
</ol>
<p><strong>核心矛盾点：</strong> 你让 <code>supervisord</code> 主进程以普通用户 <code>pwuser</code> 的身份运行，然后又在它的配置文件里要求它去执行“将子进程切换到 <code>pwuser</code> 用户下运行”这个操作。尽管目标用户是它自己，但 <code>supervisord</code> 的内部逻辑决定了处理 <code>user=</code> 指令这个行为本身就需要 <code>root</code> 权限。</p>
<hr>
<h3 id="解决方案">解决方案</h3>
<p>你有两种方法可以解决这个问题。方案一是更正确、更标准的方式。</p>
<h4 id="方案一-推荐-让-supervisord-以-root-身份运行">方案一 (推荐): 让 <code>supervisord</code> 以 <code>root</code> 身份运行</h4>
<p>进程管理器（<code>supervisord</code>）理应以 <code>root</code> 身份运行，这样它才能正确地管理它的子进程，包括将子进程降权到非特权用户（<code>pwuser</code>）下运行。这本身就是 <code>Supervisor</code> 的设计理念。</p>
<p><strong>如何修改：</strong>
在你的 <code>Dockerfile</code> 中，在 <code>CMD</code> 指令之前，简单地切换回 <code>root</code> 用户即可。</p>
<p><strong>修改后的 <code>Dockerfile</code> (只改动末尾部分):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># ... (前面所有内容保持不变)</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 7. 以非 root 用户身份安装项目级的 Playwright (这是好习惯)</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> ${APP_USER}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> ${APP_HOME}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> npm install playwright@<span style="color:#e6db74">${</span>PW_VERSION<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> rm -rf /tmp/* ~/.npm<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># --- 修复：切换回 root 用户来运行进程管理器 ---</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> root</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># 8. 暴露端口，并设置默认命令</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> ${NOVNC_PORT}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> ${PW_PORT}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/usr/bin/supervisord&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, <span style="color:#e6db74">&#34;/etc/supervisor/conf.d/supervisord.conf&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><strong>为什么这是最佳方案：</strong></p>
<ul>
<li><strong>正确性：</strong> 完全符合进程管理器的设计模式和工作原理。</li>
<li><strong>安全性：</strong> 你实际的应用程序（<code>vnc</code>, <code>fluxbox</code>, <code>novnc</code>, <code>playwright-service</code>）仍然会按照 <code>supervisord.conf</code> 的配置，以非特权的 <code>pwuser</code> 用户运行。只有 supervisor 守护进程本身是 root，这是一个标准且安全的模式。</li>
<li><strong>灵活性：</strong> 如果未来你需要增加一个以其他用户身份运行的服务，这个架构也能毫无问题地支持。</li>
</ul>
<hr>
<h4 id="方案二-备选-从-supervisordconf-中移除-user-指令">方案二 (备选): 从 <code>supervisord.conf</code> 中移除 <code>user</code> 指令</h4>
<p>如果你坚持要让 <code>supervisord</code> 以 <code>pwuser</code> 身份运行，也是可以的，但你必须移除那些要求它切换用户的配置。</p>
<p><strong>如何修改：</strong>
修改你的 <code>supervisord.conf</code> 文件，将所有 <code>[program:*]</code> 区块下的 <code>user=pwuser</code> 这一行都删除或注释掉。</p>
<p><strong>修改后的 <code>supervisord.conf</code> (部分示例):</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[supervisord]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nodaemon</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主进程将由 Docker CMD 以 pwuser 身份启动</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所以这里不需要 user 指令</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[program:vnc]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">command</span><span style="color:#f92672">=</span><span style="color:#e6db74">Xvnc :1 -geometry %(ENV_VNC_RESOLUTION)s ...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">priority</span><span style="color:#f92672">=</span><span style="color:#e6db74">10</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># user=pwuser  &lt;-- 移除此行</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">environment</span><span style="color:#f92672">=</span><span style="color:#e6db74">HOME=&#34;%(ENV_APP_HOME)s&#34;,USER=&#34;%(ENV_APP_USER)s&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[program:fluxbox]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">command</span><span style="color:#f92672">=</span><span style="color:#e6db74">/usr/bin/fluxbox</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">priority</span><span style="color:#f92672">=</span><span style="color:#e6db74">20</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># user=pwuser  &lt;-- 移除此行</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">environment</span><span style="color:#f92672">=</span><span style="color:#e6db74">DISPLAY=&#34;:1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... 其他 program 区域也做同样修改</span>
</span></span></code></pre></div><p><strong>为什么这样能行：</strong>
如果没有 <code>user</code> 指令，<code>Supervisor</code> 会以它自身的身份来启动子进程。既然你的 <code>Dockerfile</code> 已经指定了 <code>supervisord</code> 以 <code>pwuser</code> 身份运行，那么它启动的所有子进程也会自然而然地继承 <code>pwuser</code> 这个身份。</p>
<p><strong>为什么不那么理想：</strong></p>
<ul>
<li><strong>不够直观：</strong> 配置文件本身不再明确声明应用是以哪个用户运行的，而是依赖于启动 <code>supervisord</code> 的用户身份，可读性稍差。</li>
<li><strong>丧失灵活性：</strong> 你失去了让 <code>Supervisor</code> 管理不同用户进程的能力。它管理的所有进程都只能以 <code>pwuser</code> 的身份运行。</li>
</ul>
<h3 id="总结">总结</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">对比维度</th>
          <th style="text-align: left">方案一 (supervisord 以 root 运行)</th>
          <th style="text-align: left">方案二 (移除 user 指令)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>工作原理</strong></td>
          <td style="text-align: left"><code>root</code> 的 supervisord 把子进程降权为 <code>pwuser</code>。</td>
          <td style="text-align: left"><code>pwuser</code> 的 supervisord 直接以自身身份 (<code>pwuser</code>) 启动子进程。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>正确性</strong></td>
          <td style="text-align: left"><strong>高。</strong> 这是 <code>supervisor</code> 的标准用法。</td>
          <td style="text-align: left"><strong>中。</strong> 能用，但依赖于隐式行为。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>安全性</strong></td>
          <td style="text-align: left"><strong>高。</strong> 应用程序以非 root 运行，<code>supervisor</code> 本身是安全的。</td>
          <td style="text-align: left"><strong>高。</strong> 应用程序同样以非 root 运行。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>灵活性</strong></td>
          <td style="text-align: left"><strong>高。</strong> 可以管理任何用户的进程。</td>
          <td style="text-align: left"><strong>低。</strong> 所有进程必须和 <code>supervisor</code> 是同一用户。</td>
      </tr>
  </tbody>
</table>
<p><strong>结论：我强烈推荐你使用 <strong>方案一</strong>。</strong> 它是最健壮、最正确、也最易于维护的容器化实践方式。</p><ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="http://localhost:1313/blog/" >
    &copy;  Quinn's Blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
